---
import GitHub from "@/components/icons/GitHub.astro"
import Quasar from "@/components/icons/Quasar.astro"
import Vue from "@/components/icons/Vue.astro"
import Tailwind from "@/components/icons/Tailwind.astro"
import Link from "@/components/icons/Link.astro"
import LinkButton from "@/modules/LinkButton/LinkButton.astro"

const TAGS = {
  QUASAR: {
    name: "Quasar",
    class: "bg-[#7a95ff] text-white",
    icon: Quasar,
    url: "https://quasar.dev",
  },
  VUE: {
    name: "Vue",
    class: "bg-[#42b883] text-white",
    icon: Vue,
    url: "https://vuejs.org",
  },
  TAILWIND: {
    name: "Tailwind CSS",
    class: "bg-[#003159] text-white",
    icon: Tailwind,
    url: "https://tailwindcss.com",
  },
}

const PROJECTS = [
  {
    title: "ChatQuasar - Chat en vivo!",
    description:
      "Un chat desarrollado con lo √∫ltimo de Vue (Quasar). Multiples usuarios pueden conversar en el mismo chat. Logueo y autenticaci√≥n con Gmail y Firebase. Creado desde cero con Quasar.",
    link: "https://chatquasar-36f6f.web.app/",
    github: "https://github.com/NIPIO/Chat-Quasar-Firebase",
    image: "/projects/Chat.PNG",
    tags: [TAGS.QUASAR, TAGS.VUE, TAGS.TAILWIND],
  },
  {
    title: "App de Clima",
    description:
      "Aplicaci√≥n conectada a dos Apis (una de ciudades, otra de clima) para consultar el clima actual, diario y semanal. Desarrollada con historial de b√∫squeda. Creada desde cero con Vue y Tailwind CSS.",
    link: "https://weather-app-with-vue-and-tailwind.vercel.app/",
    github: "https://github.com/NIPIO/Weather-App-With-Vue-And-Tailwind",
    image: "/projects/Weather.png",
    tags: [TAGS.TAILWIND, TAGS.VUE],
  },
  {
    title: "ChatQuasar - Chat en vivo!",
    description:
      "Un chat desarrollado con lo √∫ltimo de Vue (Quasar). Multiples usuarios pueden conversar en el mismo chat. Logueo y autenticaci√≥n con Gmail y Firebase. Creado desde cero con Quasar.",
    link: "https://chatquasar-36f6f.web.app/",
    github: "https://github.com/NIPIO/Chat-Quasar-Firebase",
    image: "/projects/Chat.PNG",
    tags: [TAGS.QUASAR, TAGS.VUE, TAGS.TAILWIND],
  },
  {
    title: "App de Clima",
    description:
      "Aplicaci√≥n conectada a dos Apis (una de ciudades, otra de clima) para consultar el clima actual, diario y semanal. Desarrollada con historial de b√∫squeda. Creada desde cero con Vue y Tailwind CSS.",
    link: "https://weather-app-with-vue-and-tailwind.vercel.app/",
    github: "https://github.com/NIPIO/Weather-App-With-Vue-And-Tailwind",
    image: "/projects/Weather.png",
    tags: [TAGS.TAILWIND, TAGS.VUE],
  },
]
---

<section class="relative h-[250vh] md:h-[350vh] md:-mt-[60px]">
  <!-- CONTENEDOR STICKY -->
  <div class="sticky top-0 h-screen overflow-hidden">
    <div class="relative w-full h-full flex items-center justify-center">
      {PROJECTS.map((project, i) => (
        <div class="card" data-index={i}>
          <div class="box">
            <!-- CONTENIDO DEL PROYECTO -->
            <article class="flex flex-col md:flex-row gap-8 w-full h-full p-4 md:p-8">
              <!-- Imagen -->
              <div class="w-full md:w-1/2 flex items-center justify-center">
                <div class="relative overflow-hidden rounded-xl shadow-lg">
                  <img
                    src={project.image}
                    alt={project.title}
                    loading="lazy"
                    class="object-cover w-full h-full max-h-[320px] md:max-h-full"
                  />
                </div>
              </div>

              <!-- Texto -->
              <div class="w-full md:w-1/2 flex flex-col justify-center">
                <h3 class="text-2xl font-bold text-gray-800 dark:text-gray-100">
                  {project.title}
                </h3>

                <ul class="flex flex-wrap gap-2 mt-3">
                  {project.tags.map((tag) => (
                    <li>
                      <a
                        href={tag.url}
                        target="_blank"
                        rel="noopener noreferrer"
                        class={`flex items-center gap-x-2 rounded-full text-xs ${tag.class} py-1 px-2 hover:opacity-80 transition-opacity`}
                      >
                        <tag.icon class="size-4" />
                        {tag.name}
                      </a>
                    </li>
                  ))}
                </ul>

                <p class="mt-4 text-gray-700 dark:text-gray-400">
                  {project.description}
                </p>

                <footer class="flex gap-x-4 mt-6">
                  {project.github && (
                    <LinkButton href={project.github}>
                      <GitHub class="size-6" />
                      Code
                    </LinkButton>
                  )}
                  {project.link && (
                    <LinkButton href={project.link}>
                      <Link class="size-4" />
                      Preview
                    </LinkButton>
                  )}
                </footer>
              </div>
            </article>
          </div>
        </div>
      ))}
    </div>
  </div>
</section>

<style>
.card {
  position: absolute;
  top: 18%;
  left: 10%;
  width: 80%;
  height: 62%;
  border-radius: 2rem;

  transform:
    translateY(calc(var(--p, 0) * 140px))
    scale(calc(1 - var(--p, 0) * 0.22));

  transition: transform 0.06s linear;
  will-change: transform;
}

@media (max-width: 768px) {
  .card {
    top: 10%;
    left: 5%;
    width: 90%;
    height: 75%;
  }
}

@media (max-width: 480px) {
  .card {
    top: 5%;
    left: 2.5%;
    width: 95%;
    height: 85%;
  }
}

.box {
  width: 100%;
  height: 100%;
  border-radius: inherit;

  background: radial-gradient(
    ellipse at top right,
    rgba(120,216,115,0.35),
    rgba(255,255,255,0.96)
  );

  display: flex;
  align-items: center;
  justify-content: center;
}

/* DARK */
:global(html.dark) .box {
  background: radial-gradient(
    ellipse at top right,
    rgba(120,216,115,0.25),
    rgba(15,23,42,0.95)
  );
}
</style>

<script>
  function initProjectsScroll() {
    // Verificar si se deben deshabilitar los efectos
    const isFirefox = navigator.userAgent.toLowerCase().indexOf('firefox') > -1
    const disableEffects = localStorage.getItem('disable-3d-effects') === 'true'
    
    const cards = [...document.querySelectorAll('.card')]
    if (cards.length === 0) return
    
    // Si no es Firefox y los efectos est√°n deshabilitados, mostrar cards est√°ticas
    if (!isFirefox && disableEffects) {
      const section = document.querySelector('section.relative')
      if (section) {
        section.style.height = 'auto'
        section.style.minHeight = 'auto'
      }
      
      cards.forEach((card, i) => {
        card.style.position = 'relative'
        card.style.top = 'auto'
        card.style.left = 'auto'
        card.style.width = '100%'
        card.style.height = 'auto'
        card.style.transform = 'none'
        card.style.marginBottom = '2rem'
        card.style.opacity = '1'
        card.style.zIndex = 'auto'
      })
      
      // Cambiar el contenedor sticky a normal
      const stickyContainer = document.querySelector('.sticky')
      if (stickyContainer) {
        stickyContainer.style.position = 'relative'
        stickyContainer.style.height = 'auto'
        stickyContainer.style.overflow = 'visible'
      }
      
      const innerContainer = document.querySelector('.sticky > div')
      if (innerContainer) {
        innerContainer.style.display = 'flex'
        innerContainer.style.flexDirection = 'column'
        innerContainer.style.gap = '2rem'
        innerContainer.style.alignItems = 'stretch'
      }
      
      return
    }
    
    // Comportamiento normal con scroll
    const vh = window.innerHeight
    const total = cards.length

    function onScroll() {
      const y = window.scrollY
      const step = vh * 0.65

      cards.forEach((card, i) => {
        const start = i * step
        const p = Math.min(Math.max((y - start) / step, 0), 1)

        card.style.setProperty('--p', p)

        // üîë el activo pasa atr√°s
        const z = Math.round((1 - p) * 100) + (total - i)
        card.style.zIndex = z
      })
    }

    window.addEventListener('scroll', onScroll)
    onScroll()
  }
  
  // Inicializar cuando el DOM est√© listo
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initProjectsScroll)
  } else {
    initProjectsScroll()
  }
  
  // Reinicializar en transiciones de Astro
  document.addEventListener('astro:page-load', initProjectsScroll)
  
  // Escuchar evento para deshabilitar efectos
  window.addEventListener('disable-3d-effects', initProjectsScroll)
</script>
